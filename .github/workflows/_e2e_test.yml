name: 'e2e-test'

on:
  workflow_call:
    inputs:
      vllm:
        required: true
        type: string
      runner:
        required: true
        type: string
      image:
        required: true
        type: string
      type:
        required: true
        type: string
      vllm-kunlun:
        required: true
        type: string

jobs:
  e2e:
    name: singlecard
    runs-on:
      - self-hosted
      - Linux
      - X64

    steps:
      # =========================
      # 【新增】PR 感知关键步骤 1
      # =========================
      - name: Checkout PR code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # =========================
      # 【新增】防 self-hosted 假绿
      # =========================
      - name: Verify PR workspace
        run: |
          pwd
          ls -l
          cd "$GITHUB_WORKSPACE/vLLM-Kunlun"
          echo "==== PR commit ===="
          git rev-parse HEAD
          git log -1 --oneline
          git status --porcelain

      - name: create start_docker
        run: |
          cd /workspace
          cat << 'EOF' > start_docker.sh
          ME_PREFIX="aiak"
          IMAGE="iregistry.baidu-int.com/xmlir/xmlir_ubuntu_2004_x86_64:v0.32"
          CONFIG=".config.release"
          WORK_DIR=$(cd $(dirname $0) && pwd) && cd ${WORK_DIR}
          function create_docker() {
              local IMAGE=$(get_imagename)
              local NAME=$(get_dockername)
              DEVICE_ARGS=""
              docker run \
                  --privileged \
                  --net=host \
                  --user=root \
                  --name=$NAME \
                  -v /workspace:/workspace \
                  -v /ssd1:/ssd1 \
                  -v /ssd2:/ssd2 \
                  -v /ssd3:/ssd3 \
                  -v /dev/shm:/dev/shm \
                  --shm-size=16G \
                  -itd $IMAGE
          }
          function get_value() { grep $1 ${CONFIG} | awk -F= '{print $2}'; }
          function get_dockername() { get_value DOCKER_NAME; }
          function get_imagename() { get_value IMAGE_NAME; }
          function main() { create_docker; }
          main
          EOF
          chmod +x start_docker.sh

      - name: set config
        run: |
          cd /workspace
          cat > .config.release << 'EOF'
          DOCKER_NAME=aiak-e2e-singlecard
          IMAGE_NAME=iregistry.baidu-int.com/xmlir/xmlir_ubuntu_2004_x86_64:v0.32
          EOF

      - name: create docker
        run: |
          sudo bash /workspace/start_docker.sh
          sudo docker exec aiak-e2e-singlecard bash -lc "
            echo 'conda activate python310_torch25_cuda' >> ~/.bashrc
          "

      - name: Install vLLM 0.11.0
        run: |
          sudo docker exec aiak-e2e-singlecard bash -lc "
            conda activate python310_torch25_cuda
            pip uninstall -y vllm || true
            pip install vllm==0.11.0 --no-build-isolation --no-deps \
              --index-url https://pip.baidu-int.com/simple/
          "

      # =========================
      # 【关键修改】PR 感知安装
      # =========================
      - name: Install vLLM-kunlun (PR aware)
        run: |
          sudo docker exec aiak-e2e-singlecard bash -lc "
            conda activate python310_torch25_cuda
            cd "$GITHUB_WORKSPACE/vLLM-Kunlun"

            echo '==== Using PR code ===='
            git rev-parse HEAD
            git log -1 --oneline

            pip install -r requirements.txt
            python setup.py build
            python setup.py install

            cp vllm_kunlun/patches/eval_frame.py \
              /root/miniconda/envs/python310_torch25_cuda/lib/python3.10/site-packages/torch/_dynamo/eval_frame.py

            wget -O xpytorch.run https://baidu-kunlun-public.su.bcebos.com/xxx.run
            bash xpytorch.run

            pip install https://baidu-kunlun-public.su.bcebos.com/xxx/xtorch_ops.whl
            pip install https://cce-ai-models.bj.bcebos.com/xxx/triton.whl
            pip install https://cce-ai-models.bj.bcebos.com/xxx/xspeedgate_ops.whl

            chmod +x setup_env.sh && source setup_env.sh
          "

      - name: Module import & version check
        run: |
          sudo docker exec aiak-e2e-singlecard bash -lc "
            conda activate python310_torch25_cuda
            python -c 'import vllm; print(vllm.__version__)'
            python -c 'import importlib.metadata as m; print(m.version(\"vllm_kunlun\"))'
          "

      - name: Cleanup docker
        run: |
          sudo docker stop aiak-e2e-singlecard || true
          sudo docker rm aiak-e2e-singlecard || true
